name: Setup ArgoCD, Prometheus, Grafana

on: workflow_dispatch

permissions:
  id-token: write
  contents: read

jobs:
  helm:
      runs-on: ubuntu-latest
      steps:
        - name: Install helm
          run: |
            curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
            chmod 700 get_helm.sh
            ./get_helm.sh
            helm version

        - name: Azure login
          uses: azure/login@v2
          with:
            client-id: ${{ secrets.AZURE_CLIENT_ID }}
            tenant-id: ${{ secrets.AZURE_TENANT_ID }}
            subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

        - name: Azure CLI script
          uses: azure/cli@v2
          with:
            azcliversion: latest
            inlineScript: |
              az account show
      
        - name: setup k8s profile
          run: |
            export MY_RESOURCE_GROUP_NAME="zekn_aks_rg"
            export MY_CLUSTER_NAME="zekn-aks"
            az aks get-credentials --admin --name $MY_CLUSTER_NAME --overwrite-existing --resource-group $MY_RESOURCE_GROUP_NAME

        - name: setup ArdoCD
          run: |
            kubectl get ns
            kubectl create namespace argocd
            kubectl get ns
      # - name: Deploy to AKS
      #   run: |
      #     kubectl apply -f k8s/deployment.yaml
      #     kubectl apply -f k8s/service.yaml